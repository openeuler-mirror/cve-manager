package routers

import (
	"github.com/astaxie/beego"
	"github.com/sirupsen/logrus"

	"cvevulner/cve-ddd/adapter"
	"cvevulner/cve-ddd/app"
	"cvevulner/cve-ddd/controller"
	"cvevulner/cve-ddd/infrastructure/backendimpl"
	"cvevulner/cve-ddd/infrastructure/bulletinimpl"
	"cvevulner/cve-ddd/infrastructure/latestrpmimpl"
	"cvevulner/cve-ddd/infrastructure/majunimpl"
	"cvevulner/cve-ddd/infrastructure/obsimpl"
	"cvevulner/cve-ddd/infrastructure/repositoryimpl"
	"cvevulner/cve-ddd/infrastructure/testresultimpl"
	"cvevulner/cve-ddd/infrastructure/updateinfoimpl"
)

func Init() {
	initComment()
	initController()
	InitNewRouter()
}

func InitNewRouter() {
	log := logrus.New().WithField("module", "new-security-bulletin")

	coldPatchService := app.NewColdPatchService(
		latestrpmimpl.NewLatestRpm(),
		repositoryimpl.NewRepositoryImpl(),
		bulletinimpl.NewBulletinImpl(),
		backendimpl.NewBackendImpl(),
		updateinfoimpl.NewUpdateInfoImpl(),
		obsimpl.Instance(),
		majunimpl.NewMajunImpl(),
		testresultimpl.NewTestResultImpl(log),
		adapter.NewHotPatchAdapter(),
		log,
	)

	NewCveController := controller.NewCveController(coldPatchService, log)

	beego.Router("/security/bulletin/collect", NewCveController, "post:CollectCveData")
	beego.Router("/security/bulletin/generate", NewCveController, "post:Generate")
}
